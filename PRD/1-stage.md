# 3. 区块链存证模块需求规格说明书

## 3.1 模块概述

### 3.1.1 模块名称
区块链存证模块

### 3.1.2 模块描述
该模块负责将用户存证信息通过智能合约上链存储，提供存证信息的区块链验证功能，确保存证数据的不可篡改性和可追溯性。

### 3.1.3 功能定位
核心业务模块，为整个存证系统提供区块链技术支持。

## 3.2 功能性需求

### 3.2.1 智能合约管理功能

#### FR-3.2.1.1 智能合约部署
- **描述**：系统应支持智能合约的部署和升级
- **输入**：合约代码、部署参数
- **处理**：编译并部署智能合约到指定区块链网络
- **输出**：合约地址、部署状态
- **异常处理**：部署失败时记录错误日志并通知管理员

### 3.2.2 存证上链功能

#### FR-3.2.2.1 存证信息上链
- **描述**：将用户存证信息写入区块链
- **前置条件**：用户已完成文件上传并生成存证信息
- **输入**：存证ID、文件Hash、时间戳、用户地址
- **处理**：
  1. 构造智能合约调用参数
  2. 发起上链交易
  3. 监听交易状态
  4. 更新本地数据库状态
- **输出**：交易哈希、上链状态、区块高度
- **异常处理**：
  - 交易失败：记录失败原因，提供重试机制

#### FR-3.2.2.2 批量存证上链
- **描述**：支持批量处理多个存证信息上链
- **前置条件**：用户选择多个待上链的存证记录
- **输入**：批量存证信息列表
- **处理**：
  1. 验证所有存证信息完整性
  2. 分批构造上链交易
  3. 并行处理交易发送
  4. 统一监控交易状态
- **输出**：批量处理结果统计、各交易状态
- **性能要求**：单次批量处理不超过100条记录

### 3.2.3 存证查询验证功能

#### FR-3.2.3.1 区块链存证查询
- **描述**：根据存证ID查询区块链上的存证信息
- **前置条件**：存证信息已成功上链
- **输入**：存证ID或交易哈希
- **处理**：
  1. 调用智能合约查询接口
  2. 解析返回的区块链数据
  3. 与本地数据进行比对验证
- **输出**：完整的存证信息、上链时间、区块信息
- **响应时间**：≤3秒

#### FR-3.2.3.2 存证有效性验证
- **描述**：验证存证信息在区块链上的有效性
- **前置条件**：用户提供存证凭证
- **输入**：文件Hash、存证时间、交易哈希
- **处理**：
  1. 查询对应区块信息
  2. 验证数据一致性
  3. 检查区块确认数
- **输出**：验证结果（有效/无效）、验证时间、验证详情
- **准确性要求**：验证准确率100%

### 3.2.4 交易管理功能

#### FR-3.2.4.1 交易状态监控
- **描述**：实时监控上链交易的状态
- **输入**：交易哈希列表
- **处理**：
  1. 定期轮询交易状态
  2. 更新交易状态到数据库
  3. 触发状态变更通知
- **输出**：交易当前状态（待确认/成功/失败/pending）
- **监控频率**：每30秒轮询一次

#### FR-3.2.4.2 Gas费用管理
- **描述**：管理上链交易的Gas费用
- **输入**：Gas价格、Gas限制
- **处理**：
  1. 实时获取网络Gas价格
  2. 智能估算所需Gas费用
  3. 监控账户余额
- **输出**：费用估算结果、余额预警
- **优化策略**：支持Gas价格动态调整

## 3.3 非功能性需求

### 3.3.1 性能需求

#### NFR-3.3.1.1 响应时间
- 单次存证上链响应时间：≤5秒
- 存证查询响应时间：≤3秒
- 批量处理响应时间：≤30秒（100条记录）

#### NFR-3.3.1.2 吞吐量
- 每秒处理存证上链请求：≥10 TPS
- 同时监控交易数量：≥1000个

### 3.3.2 可靠性需求

#### NFR-3.3.2.1 系统可用性
- 区块链节点连接成功率：≥99.5%
- 交易上链成功率：≥99%
- 系统年可用性：≥99.9%

#### NFR-3.3.2.2 容错能力
- 网络异常自动重连：重连次数≥3次
- 交易失败自动重试：重试次数≥3次
- 数据一致性保证：本地与链上数据同步机制

### 3.3.3 安全性需求

#### NFR-3.3.3.1 数据安全
- 私钥存储安全：采用硬件安全模块(HSM)或加密存储
- 交易签名安全：使用标准加密算法
- 敏感信息传输：全程HTTPS加密

#### NFR-3.3.3.2 访问控制
- 智能合约访问权限控制
- 管理员操作审计日志
- 防止重放攻击机制

### 3.3.4 兼容性需求

#### NFR-3.3.4.1 区块链兼容性
- 支持EVM兼容链：以太坊、BSC、Polygon等
- 支持联盟链：BSN、FISCO BCOS等
- 支持跨链协议：未来扩展能力

#### NFR-3.3.4.2 系统兼容性
- 支持主流操作系统
- 支持Docker容器化部署
- 支持云原生架构

## 3.4 接口需求

### 3.4.1 内部接口

#### IR-3.4.1.1 文件管理模块接口
- 接口名称：getFileInfo
- 功能：获取待上链的文件存证信息
- 输入：存证ID
- 输出：文件Hash、元数据信息

#### IR-3.4.1.2 用户管理模块接口
- 接口名称：getUserWallet
- 功能：获取用户区块链钱包信息
- 输入：用户ID
- 输出：钱包地址、私钥（加密）

### 3.4.2 外部接口

#### ER-3.4.2.1 区块链节点接口
- 接口协议：JSON-RPC/WebSocket
- 主要功能：发送交易、查询状态、监听事件
- 安全要求：节点访问认证、请求频率限制

#### ER-3.4.2.2 智能合约接口
- 合约方法：storeEvidence、getEvidence、verifyEvidence
- 参数格式：ABI编码标准
- 返回格式：标准JSON格式

## 3.5 数据需求

### 3.5.1 数据结构

#### DR-3.5.1.1 存证信息结构
```
{
  "evidenceId": "string",        // 存证ID
  "fileHash": "string",          // 文件Hash
  "timestamp": "long",           // 时间戳
  "userId": "string",            // 用户ID
  "txHash": "string",            // 交易哈希
  "blockNumber": "long",         // 区块号
  "contractAddress": "string",   // 合约地址
  "status": "enum",              // 状态：pending/success/failed
  "gasUsed": "bigInteger",       // 消耗Gas
  "createTime": "datetime",      // 创建时间
  "updateTime": "datetime"       // 更新时间
}
```

### 3.5.2 数据存储
- 本地数据库：存储交易状态和关联信息
- 区块链：存储不可篡改的核心存证数据
- 缓存：热点数据Redis缓存

## 3.6 部署需求

### 3.6.1 环境要求
- 操作系统：Linux (CentOS 7+/Ubuntu 18.04+)
- 运行环境：Node.js 14+、Java 8+
- 数据库：MySQL 5.7+、Redis 5.0+
- 容器化：Docker、Kubernetes支持

### 3.6.2 监控需求
- 区块链节点健康监控
- 交易成功率监控
- Gas费用消耗监控
- 系统性能指标监控

## 3.7 质量属性

### 3.7.1 可维护性
- 模块化设计，便于功能扩展
- 完整的日志记录和错误追踪
- 标准化的API接口设计

### 3.7.2 可扩展性
- 插件化区块链网络支持
- 微服务架构便于水平扩展
- 配置化参数管理

### 3.7.3 可测试性
- 单元测试覆盖率≥80%
- 集成测试覆盖核心业务流程
- 支持自动化测试部署