# 2. 文件存证模块需求规格说明书

## 2.1 模块概述

### 2.1.1 模块名称
文件存证模块

### 2.1.2 模块描述
该模块负责处理用户文件上传、文件信息提取、Hash值计算、文件存储管理等功能，为区块链存证提供基础的文件处理能力。

### 2.1.3 功能定位
核心业务模块，是整个存证系统的基础数据处理模块。

## 2.2 功能性需求

### 2.2.1 文件上传功能

#### FR-2.2.1.1 源文件上传
- **描述**：支持用户上传原始文件进行存证
- **前置条件**：用户已登录系统
- **输入**：文件二进制数据、文件元信息
- **处理**：
  1. 验证文件格式和大小
  2. 生成临时文件存储
  3. 计算文件Hash值
  4. 存储到永久存储位置
- **输出**：文件上传状态、文件ID、Hash值、文件信息
- **异常处理**：
  - 文件格式不支持：提示用户支持的格式
  - 文件过大：提示文件大小限制
  - 上传中断：支持断点续传

#### FR-2.2.1.2 支持的文件格式
- **描述**：系统应支持多种常见文件格式
- **文本类**：TXT、DOC、DOCX、PDF、RTF
- **图像类**：JPG、JPEG、PNG、GIF、BMP、TIFF
- **音视频类**：MP3、WAV、MP4、AVI、MOV、FLV
- **压缩包类**：ZIP、RAR、7Z
- **其他格式**：根据业务需求可扩展

#### FR-2.2.1.3 文件大小限制
- **描述**：对上传文件大小进行限制管理
- **单文件限制**：≤100MB（可配置）
- **批量上传**：≤1GB（可配置）
- **处理机制**：超限文件拒绝上传并提示用户

#### FR-2.2.1.4 断点续传
- **描述**：支持大文件断点续传功能
- **前置条件**：网络中断或上传失败的文件
- **输入**：已上传部分文件数据、文件标识
- **处理**：
  1. 检查已上传文件片段
  2. 计算断点位置
  3. 从断点继续上传
  4. 合并完整文件
- **输出**：续传进度、最终上传状态
- **可靠性要求**：续传成功率≥99%

### 2.2.2 Hash值存证功能

#### FR-2.2.2.1 Hash值手动输入
- **描述**：支持用户直接输入文件Hash值进行存证
- **前置条件**：用户选择Hash存证模式
- **输入**：Hash值字符串、Hash算法类型
- **处理**：
  1. 验证Hash值格式
  2. 检查Hash算法支持性
  3. 生成存证记录
- **输出**：Hash验证结果、存证ID
- **验证规则**：
  - SHA256：64位十六进制字符
  - MD5：32位十六进制字符
  - SHA1：40位十六进制字符

#### FR-2.2.2.2 Hash算法支持
- **描述**：系统应支持多种Hash算法
- **必须支持**：SHA256、MD5、SHA1
- **可选支持**：SHA512、SHA3-256、BLAKE2
- **默认算法**：SHA256
- **扩展能力**：支持新增Hash算法

### 2.2.3 文件信息处理功能

#### FR-2.2.3.1 文件元信息提取
- **描述**：自动提取上传文件的元信息
- **前置条件**：文件上传成功
- **输入**：文件二进制数据
- **处理**：
  1. 分析文件头信息
  2. 提取文件属性
  3. 识别文件真实类型
- **输出**：
  - 文件名、文件大小、文件类型
  - 创建时间、修改时间
  - MIME类型、编码格式
  - 文件描述（可选）

#### FR-2.2.3.2 文件Hash计算
- **描述**：计算文件的Hash值用于存证
- **前置条件**：文件上传完成
- **输入**：文件二进制数据、Hash算法选择
- **处理**：
  1. 读取文件内容
  2. 按指定算法计算Hash
  3. 验证Hash计算结果
- **输出**：文件Hash值、计算耗时
- **性能要求**：100MB文件Hash计算时间≤30秒

#### FR-2.2.3.3 文件预览生成
- **描述**：为支持的文件格式生成预览内容
- **前置条件**：文件上传成功且格式支持预览
- **输入**：文件二进制数据
- **处理**：
  1. 判断文件是否支持预览
  2. 生成缩略图或预览内容
  3. 存储预览文件
- **输出**：预览文件URL、预览状态
- **支持格式**：图片缩略图、PDF前几页、文档摘要

### 2.2.4 文件存储管理功能

#### FR-2.2.4.1 文件加密存储
- **描述**：对上传文件进行加密存储
- **前置条件**：文件准备存储
- **输入**：明文文件数据、加密密钥
- **处理**：
  1. 生成文件加密密钥
  2. 对文件进行AES-256加密
  3. 存储加密后的文件
  4. 保存密钥信息（加密存储）
- **输出**：加密文件存储路径、加密状态
- **安全要求**：符合国家密码管理要求


### 2.2.5 存证记录管理功能

#### FR-2.2.5.1 存证记录创建
- **描述**：创建文件存证记录
- **前置条件**：文件处理完成
- **输入**：文件信息、用户信息、Hash值
- **处理**：
  1. 生成唯一存证ID
  2. 创建存证记录
  3. 关联文件和用户信息
- **输出**：存证ID、存证记录状态
- **ID规则**：全局唯一、时间戳+随机数

#### FR-2.2.5.2 存证状态跟踪
- **描述**：跟踪文件存证的完整状态
- **状态流转**：
  - 上传中(UPLOADING) → 上传完成(UPLOADED)
  - → 处理中(PROCESSING) → 处理完成(PROCESSED)
  - → 上链中(CHAINING) → 已存证(CERTIFIED)
- **更新机制**：实时状态更新、异步通知
- **查询接口**：支持按状态查询存证记录

## 2.3 非功能性需求

### 2.3.1 性能需求

#### NFR-2.3.1.1 响应时间
- 文件上传响应时间：≤3秒（首包）
- Hash计算时间：100MB文件≤30秒
- 文件信息提取时间：≤5秒
- 存证记录创建时间：≤2秒

#### NFR-2.3.1.2 吞吐量
- 并发文件上传：≥100个同时上传
- 文件处理能力：≥50个文件/秒
- 存储I/O性能：≥1GB/s

### 2.3.2 可靠性需求

#### NFR-2.3.2.1 数据完整性
- 文件传输完整性：100%保证
- Hash计算准确性：无错误率
- 存储数据持久性：99.999999999%（11个9）

#### NFR-2.3.2.2 系统稳定性
- 文件上传成功率：≥99.9%
- 系统年可用性：≥99.95%
- 故障恢复时间：≤30分钟

### 2.3.3 安全性需求

#### NFR-2.3.3.1 数据安全
- 传输安全：HTTPS加密传输
- 存储安全：AES-256加密存储
- 访问控制：基于角色的权限管理
- 防病毒扫描：上传文件100%扫描

#### NFR-2.3.3.2 隐私保护
- 用户文件隔离：不同用户文件完全隔离
- 敏感信息脱敏：日志中不记录文件内容
- 数据访问审计：完整操作日志记录

### 2.3.4 兼容性需求

#### NFR-2.3.4.1 浏览器兼容性
- 主流浏览器：Chrome、Firefox、Safari、Edge最新版本
- 移动端浏览器：iOS Safari、Android Chrome
- 兼容性测试覆盖率：≥95%

#### NFR-2.3.4.2 设备兼容性
- 桌面设备：Windows、macOS、Linux
- 移动设备：iOS、Android
- 响应式设计：适配不同屏幕尺寸

## 2.4 接口需求

### 2.4.1 内部接口

#### IR-2.4.1.1 用户管理模块接口
- 接口名称：validateUserQuota
- 功能：验证用户存储配额
- 输入：userId、fileSize
- 输出：quotaCheckResult、availableSpace

#### IR-2.4.1.2 区块链存证模块接口
- 接口名称：createEvidenceRecord
- 功能：创建区块链存证记录
- 输入：fileHash、fileInfo、userId
- 输出：evidenceId、recordStatus

#### IR-2.4.1.3 通知服务接口
- 接口名称：sendNotification
- 功能：发送存证状态通知
- 输入：userId、notificationType、message
- 输出：sendResult

### 2.4.2 外部接口

#### ER-2.4.2.1 存储服务接口
- 接口协议：S3兼容API或自定义存储API
- 主要功能：文件上传、下载、删除、查询
- 安全要求：访问认证、权限控制

#### ER-2.4.2.2 防病毒服务接口
- 接口协议：RESTful API
- 主要功能：文件病毒扫描
- 响应时间：≤10秒（100MB文件）

## 2.5 数据需求

### 2.5.1 数据结构

#### DR-2.5.1.1 文件信息结构
```
{
  "fileId": "string",           // 文件唯一ID
  "fileName": "string",         // 原始文件名
  "fileSize": "long",           // 文件大小(字节)
  "fileType": "string",         // 文件类型
  "mimeType": "string",         // MIME类型
  "fileHash": "string",         // 文件Hash值
  "hashAlgorithm": "string",    // Hash算法
  "uploadTime": "datetime",     // 上传时间
  "userId": "string",           // 上传用户ID
  "storagePath": "string",      // 存储路径
  "previewPath": "string",      // 预览文件路径
  "status": "enum",             // 文件状态
  "metadata": "object"          // 文件元数据
}
```

#### DR-2.5.1.2 存证记录结构
```
{
  "evidenceId": "string",       // 存证ID
  "fileId": "string",           // 关联文件ID
  "userId": "string",           // 用户ID
  "evidenceType": "enum",       // 存证类型(FILE/HASH)
  "fileHash": "string",         // 存证Hash
  "createTime": "datetime",     // 创建时间
  "status": "enum",             // 存证状态
  "relatedTx": "string",        // 关联区块链交易
  "certificateUrl": "string"    // 存证证书URL
}
```

### 2.5.2 数据存储
- **关系数据库**：MySQL存储文件元信息和存证记录
- **对象存储**：分布式存储系统存储文件本体
- **缓存系统**：Redis缓存热点数据和临时信息
- **搜索引擎**：Elasticsearch支持文件检索

## 2.6 部署需求

### 2.6.1 环境要求
- **操作系统**：Linux (CentOS 7+/Ubuntu 18.04+)
- **运行环境**：Node.js 14+、Java 8+、Python 3.7+
- **数据库**：MySQL 5.7+、Redis 5.0+
- **存储系统**：分布式文件存储(minIO/Ceph)或云存储服务

### 2.6.2 监控需求
- **文件上传监控**：成功率、响应时间、流量统计
- **存储容量监控**：使用率、增长趋势
- **系统性能监控**：CPU、内存、磁盘I/O
- **安全监控**：异常访问、病毒检测

## 2.7 质量属性

### 2.7.1 可维护性
- **模块化设计**：功能模块解耦，便于独立维护
- **日志记录**：完整的操作日志和错误日志
- **配置管理**：参数配置化，支持动态调整
- **版本控制**：Git版本管理，支持灰度发布

### 2.7.2 可扩展性
- **微服务架构**：支持水平扩展和独立部署
- **插件化设计**：支持新文件格式和处理算法
- **API标准化**：统一接口规范，便于第三方集成
- **存储扩展**：支持多种存储后端切换

### 2.7.3 可测试性
- **单元测试**：核心功能单元测试覆盖率≥85%
- **集成测试**：模块间接口集成测试
- **性能测试**：支持压力测试和容量规划
- **自动化测试**：CI/CD集成自动化测试流程